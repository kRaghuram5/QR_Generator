name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: qr-code-generator
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  # Job 1: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        pytest test_app.py -v --tb=short
    
    - name: Test QR generation
      run: |
        python -c "import qrcode; qr = qrcode.QRCode(); qr.add_data('test'); qr.make(); print('QR generation test passed')"

  # Job 2: Build and Test Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:latest .
    
    - name: Test Docker image
      run: |
        docker run -d -p 5000:5000 --name test-container ${{ env.DOCKER_IMAGE_NAME }}:latest
        echo "Waiting for container to start..."
        sleep 20
        echo "Container logs:"
        docker logs test-container
        echo "Testing health endpoint..."
        for i in {1..10}; do
          if curl -f http://localhost:5000/health; then
            echo "Health check passed!"
            docker stop test-container
            docker rm test-container
            exit 0
          fi
          echo "Attempt $i failed, retrying..."
          sleep 2
        done
        echo "Health check failed after 10 attempts"
        docker logs test-container
        docker stop test-container
        docker rm test-container
        exit 1
    
    - name: Save Docker image
      run: |
        docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | gzip > qr-app-image.tar.gz
    
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: qr-app-image.tar.gz
        retention-days: 1

  # Job 3: Push to Docker Hub (Optional - only on main branch)
  push-to-dockerhub:
    name: Push to Docker Hub
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      if: env.DOCKER_USERNAME != ''
    
    - name: Build and push Docker image
      if: env.DOCKER_USERNAME != ''
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest .
        docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
    
    - name: Skip Docker Hub push
      if: env.DOCKER_USERNAME == ''
      run: |
        echo "‚ö†Ô∏è Docker Hub credentials not configured. Skipping push."
        echo "To enable Docker Hub push, add DOCKER_USERNAME and DOCKER_PASSWORD to GitHub Secrets."

  # Job 4: Deploy (Local/Demo)
  deploy-info:
    name: Deployment Information
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Display deployment instructions
      run: |
        echo "==================================="
        echo "‚úÖ Build and Tests Completed!"
        echo "==================================="
        echo ""
        echo "üöÄ To run the application locally:"
        echo ""
        echo "  docker run -d -p 5000:5000 --name qr-generator ${{ env.DOCKER_IMAGE_NAME }}:latest"
        echo ""
        echo "üìù Then open: http://localhost:5000"
        echo ""
        echo "==================================="
